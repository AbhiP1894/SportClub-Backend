pipeline {
    agent {
        label 'Trivy_slave_node'
    }
    tools {
        maven 'Maven'
        jdk 'JDK11'
    }

    stages {
        stage('package') {
            steps {
                echo 'Package'
                sh 'mvn clean package'
            }
        }
        stage('Build') {
            steps {
                echo 'Build Docker image'
                sh 'docker build -t abhi_patil/sportclub-backend:latest .'
            }
        }

        stage('Trivy Scan') {
            steps { 
                echo 'Running Trivy scan'
                sh 'trivy image --severity HIGH,CRITICAL abhi_patil/sportclub-backend:latest'
            }
        }
        stage('Generate Trivy Report') {
            steps {
                echo 'Generating Trivy report'
                sh 'trivy image -f json -o results.html abhi_patil/sportclub-backend:latest'
            }
        }
        stage('Publish Trivy HTML Report') {
            steps { 
                echo 'Publishing Trivy HTML report'
                sh 'curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl > html.tpl'
                sh 'mkdir -p reports'
                sh 'trivy image --ignore-unfixed --vuln-type os,library --format template --template "@./html.tpl" -o reports/trivy-scan.html abhi_patil/sportclub-backend:latest'
                publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: false, reportDir: 'reports', reportFiles: 'trivy-scan.html', reportName: 'Trivy Scan', reportTitles: '', useWrapperFileDirectly: true])   
            }
        }
        stage('Job Status') {
            steps {
                script {
              def imageName = 'abhi_patil/sportclub-backend:latest'
                    def trivyOutput = sh script: "trivy image --exit-code 1 -f json ${imageName}", returnStatus: true
             if (trivyOutput == 0) {
                        echo "No critical vulnerabilities found."
                    } else if (trivyOutput == 1) {
                        error "Critical vulnerabilities found. Failing the build."
                    } else {
                        error "Trivy scan failed with an unexpected exit code: ${trivyOutput}"
                    }
                }
            }
        }
    }
}
